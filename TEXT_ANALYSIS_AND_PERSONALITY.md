# Анализ текста и голосовых сообщений. Характеристики личности для клонов

## Процесс анализа текста и голоса

### Этап 1: Получение текста

#### Голосовое сообщение:
1. **Запись аудио** в Mini App (Web Audio API)
2. **Отправка на бэкенд** (multipart/form-data)
3. **Транскрипция через OpenAI Whisper API:**
```python
# Псевдокод
audio_file = open("diary_audio.webm", "rb")
transcription = openai.audio.transcriptions.create(
    model="whisper-1",
    file=audio_file,
    language="ru"  # Определяется автоматически, но можно указать
)
text = transcription.text
```

**Результат:** Текст дневника на русском языке

#### Текстовое сообщение:
- Текст приходит напрямую от пользователя
- Валидация: минимальная длина (например, 50 символов)
- Очистка от лишних пробелов и форматирования

---

### Этап 2: Анализ текста через GPT-4

#### Промпт для анализа дневника:

```
Ты - эксперт по анализу личности. Проанализируй дневник человека и извлеки структурированную информацию.

ДНЕВНИК:
{diary_text}

ИЗВЛЕКИ СЛЕДУЮЩУЮ ИНФОРМАЦИЮ:

1. ЭМОЦИИ И НАСТРОЕНИЕ:
   - Основные эмоции (радость, грусть, тревога, спокойствие, злость, страх и т.д.)
   - Интенсивность эмоций (1-10)
   - Общее настроение (positive/neutral/negative)

2. ЦЕННОСТИ И ПРИОРИТЕТЫ:
   - Что важно для человека (семья, карьера, дружба, саморазвитие, деньги, здоровье и т.д.)
   - Приоритеты (что важнее всего)
   - Этические принципы

3. ИНТЕРЕСЫ И ХОББИ:
   - Чем увлекается
   - Что любит делать
   - Какие темы интересуют

4. СТИЛЬ ОБЩЕНИЯ:
   - Формальность (формальный/неформальный/смешанный)
   - Использование юмора (да/нет, какой тип)
   - Длина предложений (короткие/средние/длинные)
   - Использование сленга
   - Эмоциональность речи
   - Часто используемые слова и фразы

5. ПАТТЕРНЫ МЫШЛЕНИЯ:
   - Аналитический или интуитивный
   - Оптимист или пессимист
   - Фокус на деталях или общей картине
   - Логический или эмоциональный подход к решениям

6. ЦЕЛИ И МЕЧТЫ:
   - Краткосрочные цели
   - Долгосрочные мечты
   - Что хочет достичь

7. СТРАХИ И ПРОБЛЕМЫ:
   - О чем беспокоится
   - Какие страхи упоминаются
   - Текущие проблемы

8. ОПЫТ И СОБЫТИЯ:
   - Важные события из дневника
   - Опыт, который повлиял на человека
   - Взаимодействия с другими людьми

9. ПОТРЕБНОСТИ И ПРЕДЛОЖЕНИЯ:
   - Что нужно (вещи, работа, услуги)
   - Что предлагает (вещи, работа, услуги)
   - Локация (если упоминается)

10. КЛЮЧЕВЫЕ ФРАЗЫ:
    - Характерные выражения
    - Часто повторяющиеся слова
    - Уникальные обороты речи

ВЕРНИ ОТВЕТ В ФОРМАТЕ JSON:
{
    "emotions": {
        "primary": ["радость", "спокойствие"],
        "intensity": 7,
        "mood": "positive"
    },
    "values": ["семья", "саморазвитие", "честность"],
    "interests": ["программирование", "музыка", "путешествия"],
    "communication_style": {
        "formality": "неформальный",
        "humor": "да, ироничный",
        "sentence_length": "средние",
        "slang": "иногда",
        "emotionality": "высокая",
        "common_phrases": ["короче", "в общем", "типа"]
    },
    "thinking_patterns": {
        "type": "аналитический",
        "optimism": "оптимист",
        "focus": "детали",
        "decision_style": "логический"
    },
    "goals": ["выучить Python", "найти работу мечты"],
    "fears": ["неудача", "одиночество"],
    "experiences": ["переехал в новый город", "начал изучать программирование"],
    "needs": [
        {"type": "thing", "item": "чайник", "location": "Москва"}
    ],
    "offers": [],
    "key_phrases": ["короче говоря", "в принципе", "типа того"]
}
```

#### Обработка ответа:

```python
# Псевдокод
response = await openai.chat.completions.create(
    model="gpt-4",
    messages=[
        {"role": "system", "content": analysis_prompt},
        {"role": "user", "content": diary_text}
    ],
    response_format={"type": "json_object"},  # Важно для JSON ответа
    temperature=0.3  # Низкая температура для более точного анализа
)

analysis_result = json.loads(response.choices[0].message.content)
```

---

### Этап 3: Сохранение и обновление профиля клона

#### Обновление personality_profile:

```python
# Псевдокод
clone = get_clone(user_id)

# Объединяем старые данные с новыми (взвешенное усреднение)
new_profile = merge_profiles(
    old_profile=clone.personality_profile,
    new_analysis=analysis_result,
    weight=0.3  # Новые данные имеют вес 30%, старые 70%
)

clone.personality_profile = new_profile
clone.updated_at = now()
```

#### Создание воспоминаний (memories):

```python
# Извлекаем конкретные факты для памяти
memories_to_create = []

# Факты о предпочтениях
if "interests" in analysis_result:
    for interest in analysis_result["interests"]:
        memories_to_create.append({
            "type": "preference",
            "content": f"Любит {interest}",
            "importance": 0.7
        })

# Факты о ценностях
if "values" in analysis_result:
    for value in analysis_result["values"]:
        memories_to_create.append({
            "type": "value",
            "content": f"Ценит {value}",
            "importance": 0.9  # Ценности очень важны
        })

# Конкретные события
if "experiences" in analysis_result:
    for experience in analysis_result["experiences"]:
        memories_to_create.append({
            "type": "experience",
            "content": experience,
            "importance": 0.6
        })

# Сохраняем в БД
for memory_data in memories_to_create:
    create_memory(clone_id, diary_id, memory_data)
```

---

## Характеристики личности для клонов

### 1. Базовые демографические данные

**Из анкеты:**
- Имя
- Возраст
- Город
- Пол

**Хранение:** `users` таблица

---

### 2. Ценности и приоритеты

**Что это:** То, что человек считает важным в жизни

**Примеры:**
- Семья
- Карьера
- Саморазвитие
- Дружба
- Здоровье
- Деньги
- Свобода
- Безопасность
- Творчество
- Признание
- Помощь другим
- Стабильность

**Как извлекается:**
- Анализ тем, о которых человек говорит чаще всего
- Что вызывает сильные эмоции
- На что тратит время и силы

**Хранение:** `clones.personality_profile["values"]` (массив)

**Использование:**
- Поиск совместимостей (совпадение ценностей)
- Предсказание решений ("Что бы я сделал?")
- Понимание мотивации

---

### 3. Эмоциональные паттерны

**Что это:** Как человек переживает эмоции, какие эмоции преобладают

**Характеристики:**
- **Базовое настроение:** оптимист / пессимист / реалист
- **Эмоциональная стабильность:** стабильный / переменчивый
- **Интенсивность эмоций:** низкая / средняя / высокая
- **Преобладающие эмоции:** радость, спокойствие, тревога, грусть
- **Эмоциональные триггеры:** что вызывает сильные эмоции
- **Способы выражения:** открыто / сдержанно

**Как извлекается:**
- Анализ эмоций в каждом дневнике
- Паттерны: утром обычно X, вечером Y
- Что вызывает положительные/отрицательные эмоции

**Хранение:** 
- `clones.personality_profile["emotional_patterns"]` (объект)
- `clone_memories` с типом "emotional_pattern"

**Использование:**
- Клон понимает, как пользователь реагирует на события
- Предсказывает эмоциональные реакции
- Находит эмоционально совместимых людей

---

### 4. Стиль общения

**Что это:** Как человек выражает мысли, как говорит

**Характеристики:**

**Формальность:**
- Формальный (официальный стиль)
- Неформальный (дружеский стиль)
- Смешанный

**Юмор:**
- Использует ли юмор (да/нет)
- Тип юмора (ирония, сарказм, легкий, черный юмор)
- Частота использования

**Длина предложений:**
- Короткие (лаконичные)
- Средние
- Длинные (развернутые)

**Эмоциональность речи:**
- Низкая (сдержанный)
- Средняя
- Высокая (эмоциональный)

**Использование сленга:**
- Никогда
- Редко
- Часто
- Постоянно

**Часто используемые слова/фразы:**
- Характерные выражения ("короче", "в общем", "типа")
- Междометия ("эх", "ой", "ну")
- Специфические слова

**Как извлекается:**
- Анализ текста дневников
- Поиск повторяющихся фраз
- Анализ структуры предложений
- Определение уровня формальности

**Хранение:** `clones.personality_profile["communication_style"]` (объект)

**Использование:**
- Клон говорит в том же стиле
- Поиск людей с похожим стилем общения
- Генерация ответов в характерной манере

---

### 5. Паттерны мышления

**Что это:** Как человек думает, обрабатывает информацию, принимает решения

**Характеристики:**

**Тип мышления:**
- Аналитический (логика, факты, анализ)
- Интуитивный (чувства, интуиция, образы)
- Смешанный

**Оптимизм/Пессимизм:**
- Оптимист (видит хорошее)
- Пессимист (видит проблемы)
- Реалист (баланс)

**Фокус внимания:**
- На деталях (замечает мелочи)
- На общей картине (видит целое)
- Сбалансированный

**Подход к решениям:**
- Логический (анализ плюсов/минусов)
- Эмоциональный (чувства и интуиция)
- Компромиссный

**Скорость принятия решений:**
- Быстро (импульсивно)
- Медленно (обдумывает долго)
- Средне

**Как извлекается:**
- Анализ того, как человек описывает проблемы
- Как объясняет свои решения
- Какие аргументы использует
- Как планирует действия

**Хранение:** `clones.personality_profile["thinking_patterns"]` (объект)

**Использование:**
- Клон думает похожим образом
- Предсказывает решения пользователя
- Находит людей с похожим мышлением

---

### 6. Интересы и хобби

**Что это:** Чем человек увлекается, что любит делать

**Категории:**
- Спорт и активность
- Творчество (музыка, рисование, писательство)
- Технологии
- Путешествия
- Чтение
- Кино и сериалы
- Игры
- Кулинария
- Изучение языков
- И т.д.

**Как извлекается:**
- Прямые упоминания ("люблю программировать")
- Темы, о которых говорит часто
- То, что вызывает положительные эмоции

**Хранение:** 
- `clones.personality_profile["interests"]` (массив)
- `clone_memories` с типом "preference"

**Использование:**
- Поиск людей с похожими интересами
- Рекомендации и советы
- Темы для общения

---

### 7. Цели и мечты

**Что это:** Чего человек хочет достичь

**Типы:**
- Карьерные цели
- Личностные (саморазвитие)
- Материальные
- Отношения
- Здоровье
- Творческие

**Как извлекается:**
- Прямые упоминания ("хочу выучить Python")
- Планы на будущее
- Мечты и желания

**Хранение:**
- `clones.personality_profile["goals"]` (массив)
- `clone_memories` с типом "goal"

**Использование:**
- Поиск совпадений (оба хотят одно и то же)
- Мотивация и поддержка
- Предсказание действий

---

### 8. Страхи и проблемы

**Что это:** О чем человек беспокоится, чего боится

**Типы:**
- Страх неудачи
- Страх одиночества
- Страх потери
- Финансовые страхи
- Страх перемен
- И т.д.

**Как извлекается:**
- Прямые упоминания ("боюсь", "страшно")
- Тематический анализ беспокойств
- Проблемы, которые упоминаются часто

**Хранение:**
- `clones.personality_profile["fears"]` (массив)
- `clone_memories` с типом "fear"

**Использование:**
- Понимание ограничений человека
- Предсказание реакций на стресс
- Поиск поддержки

---

### 9. Опыт и события

**Что это:** Важные события из жизни, опыт, который повлиял

**Типы:**
- Переезды
- Смена работы
- Важные отношения
- Достижения
- Потери
- Обучение

**Как извлекается:**
- Описание событий в дневниках
- Упоминания прошлого опыта
- Связь событий с эмоциями

**Хранение:** `clone_memories` с типом "experience"

**Использование:**
- Контекст для понимания решений
- Понимание причин поведения
- Истории для общения

---

### 10. Социальные характеристики

**Что это:** Как человек взаимодействует с другими

**Характеристики:**
- Экстраверт / Интроверт
- Лидер / Последователь
- Независимый / Зависимый от других
- Открытый / Закрытый
- Доверчивый / Осторожный

**Как извлекается:**
- Упоминания взаимодействий с людьми
- Как описывает отношения
- Предпочтения в общении

**Хранение:** `clones.personality_profile["social_traits"]` (объект)

---

### 11. Поведенческие паттерны

**Что это:** Как человек действует в разных ситуациях

**Характеристики:**
- Реакция на стресс (спокойно / паникует / уходит в себя)
- Решение конфликтов (избегает / решает / конфронтация)
- Работа в команде (командный игрок / одиночка)
- Привычки и рутины

**Как извлекается:**
- Описание ситуаций и реакций
- Паттерны в поведении
- Повторяющиеся действия

**Хранение:** `clones.personality_profile["behavioral_patterns"]` (объект)

---

## Структура personality_profile в БД

```json
{
    "demographics": {
        "age": 28,
        "gender": "male",
        "city": "Москва"
    },
    "values": ["семья", "карьера", "саморазвитие"],
    "interests": ["программирование", "музыка", "путешествия"],
    "communication_style": {
        "formality": "неформальный",
        "humor": "да, ироничный",
        "sentence_length": "средние",
        "slang": "иногда",
        "emotionality": "высокая",
        "common_phrases": ["короче", "в общем", "типа"]
    },
    "thinking_patterns": {
        "type": "аналитический",
        "optimism": "оптимист",
        "focus": "детали",
        "decision_style": "логический",
        "decision_speed": "средне"
    },
    "emotional_patterns": {
        "base_mood": "оптимист",
        "stability": "стабильный",
        "intensity": "средняя",
        "primary_emotions": ["радость", "спокойствие"],
        "triggers": {
            "positive": ["успех в работе", "время с семьей"],
            "negative": ["неудачи", "конфликты"]
        }
    },
    "goals": ["выучить Python", "найти работу мечты"],
    "fears": ["неудача", "одиночество"],
    "social_traits": {
        "extroversion": "интроверт",
        "leadership": "последователь",
        "independence": "независимый",
        "openness": "открытый"
    },
    "behavioral_patterns": {
        "stress_reaction": "спокойно",
        "conflict_resolution": "решает",
        "team_work": "командный игрок"
    },
    "strengths": ["коммуникабельность", "упорство"],
    "weaknesses": ["перфекционизм"]
}
```

---

## Как клон использует эти характеристики

### При ответе на вопрос:

1. **Поиск релевантного контекста:**
   - Векторный поиск в памяти
   - Поиск похожих ситуаций в дневниках

2. **Формирование ответа:**
   - Использует стиль общения пользователя
   - Учитывает паттерны мышления
   - Опирается на ценности
   - Учитывает эмоциональные паттерны

3. **Пример:**
   - Вопрос: "Что бы я сделал, если бы мне предложили переезд?"
   - Клон учитывает:
     * Ценности (семья важнее карьеры)
     * Страхи (боится одиночества)
     * Опыт (ранее говорил о нежелании переезжать)
     * Стиль общения (неформальный, с юмором)
   - Ответ: "Скорее всего, ты бы попросил удаленную работу или гибкий график. Ты ценишь близость с семьей, и полный переезд был бы слишком тяжелым. Помню, ты говорил, что не хочешь оставлять родителей."

---

## Интерактивная анкета при первом входе

### Процесс заполнения анкеты

**Экран 1: Приветствие**
- "Привет! Я помогу создать твоего ИИ-клона. Давай начнем с нескольких вопросов."

**Экран 2: Вопрос 1 - Имя**
- Вопрос: "Как тебя зовут?"
- Поле ввода (текст)
- Кнопка "Далее"
- Валидация: не пустое, минимум 2 символа

**Экран 3: Вопрос 2 - Возраст**
- Вопрос: "Сколько тебе лет?"
- Поле ввода (число) или селектор (18-100)
- Кнопка "Далее"
- Валидация: число от 13 до 120

**Экран 4: Вопрос 3 - Город**
- Вопрос: "Из какого ты города?"
- Поле ввода с автодополнением (можно использовать API городов)
- Кнопка "Далее"
- Валидация: не пустое

**Экран 5: Вопрос 4 - Пол**
- Система анализирует имя и предполагает пол
- Вопрос: "Вы мужчина или женщина?" (или "Вы {предположение}?")
- Варианты: "Мужчина" / "Женщина" / "Другое" / "Не указывать"
- Кнопка "Далее"

**Экран 6: Завершение**
- "Отлично! Теперь давай создадим твоего клона. Запиши свой первый дневник!"

### Техническая реализация

**В Mini App:**
```typescript
// Псевдокод
interface OnboardingState {
    step: 'welcome' | 'name' | 'age' | 'city' | 'gender' | 'complete';
    data: {
        name?: string;
        age?: number;
        city?: string;
        gender?: string;
    };
}

// Компонент анкеты
function OnboardingForm() {
    const [state, setState] = useState<OnboardingState>({
        step: 'welcome',
        data: {}
    });
    
    const handleAnswer = async (answer: string) => {
        // Сохраняем ответ
        const newData = { ...state.data, [currentField]: answer };
        
        // Отправляем на бэкенд
        await api.post('/api/onboarding/answer', {
            field: currentField,
            value: answer
        });
        
        // Переходим к следующему вопросу
        setState({ ...state, data: newData, step: nextStep });
    };
    
    // Определение следующего шага
    const nextStep = getNextStep(state.step);
    
    // Предположение пола по имени (на бэкенде)
    if (state.step === 'gender' && state.data.name) {
        const genderGuess = await api.get(`/api/onboarding/guess-gender?name=${state.data.name}`);
        // Показываем предположение
    }
}
```

**На бэкенде:**

```python
# API endpoint для ответа на вопрос анкеты
@app.post("/api/onboarding/answer")
async def save_onboarding_answer(
    telegram_id: int,
    field: str,
    value: str
):
    user = get_user_by_telegram_id(telegram_id)
    
    # Сохраняем ответ
    if field == "name":
        user.first_name = value
    elif field == "age":
        user.age = int(value)
    elif field == "city":
        user.city = value
    elif field == "gender":
        user.gender = value
    
    await db.commit()
    
    return {"status": "saved", "next_field": get_next_field(field)}

# API для предположения пола
@app.get("/api/onboarding/guess-gender")
async def guess_gender(name: str):
    # Простой анализ имени (можно использовать библиотеку или ИИ)
    # Или использовать GPT для анализа
    response = await openai.chat.completions.create(
        model="gpt-3.5-turbo",
        messages=[
            {"role": "system", "content": "Определи пол по имени. Ответь только: мужчина, женщина или неизвестно."},
            {"role": "user", "content": name}
        ],
        temperature=0.1
    )
    
    guess = response.choices[0].message.content.lower()
    return {"gender": guess}
```

**Сохранение в БД:**
- Все ответы сохраняются в таблицу `users` сразу после ответа
- После завершения анкеты создается запись `clone` с базовым профилем
- Анкета больше не показывается (флаг `onboarding_completed` в `users`)

---

## Пример полного процесса анализа

**Входные данные:**
- Голосовое сообщение: 2 минуты речи о дне пользователя

**Процесс:**

1. **Транскрипция:**
   ```
   "Сегодня был отличный день! Утром закончил проект на работе, 
   начальник похвалил. Потом пошел в спортзал, давно не занимался. 
   Вечером встретился с друзьями, обсудили планы на выходные. 
   Кстати, мне нужен новый чайник, старый сломался. Живу в Москве, 
   может кто знает где купить хороший?"
   ```

2. **Анализ GPT-4:**
   ```json
   {
       "emotions": {
           "primary": ["радость", "удовлетворение"],
           "intensity": 8,
           "mood": "positive"
       },
       "values": ["работа", "здоровье", "дружба"],
       "interests": ["спорт", "общение с друзьями"],
       "communication_style": {
           "formality": "неформальный",
           "humor": "нет",
           "sentence_length": "средние",
           "slang": "редко",
           "emotionality": "высокая"
       },
       "needs": [
           {"type": "thing", "item": "чайник", "location": "Москва"}
       ]
   }
   ```

3. **Создание воспоминаний:**
   - "Ценит работу и признание начальства"
   - "Занимается спортом"
   - "Ценит дружбу и общение"
   - "Нужен чайник в Москве"

4. **Обновление профиля клона:**
   - Добавление новых ценностей
   - Обновление интересов
   - Сохранение потребности

5. **Результат:**
   - Клон теперь знает, что пользователь ценит работу и спорт
   - Клон может ответить на вопрос о покупке чайника
   - Система ищет совпадения по потребности в чайнике

---

Этот подход позволяет создавать детальные профили клонов, которые ведут себя как реальные люди, используя все извлеченные характеристики.
