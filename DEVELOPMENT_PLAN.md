# План разработки Telegram Mini App: Платформа ИИ-клонов

## Архитектура системы

### Компоненты системы

1. **Telegram Bot** (точка входа)
   - Обработка команд
   - Уведомления пользователям
   - Открытие Mini App
   - Валидация пользователей

2. **Telegram Mini App** (фронтенд)
   - Веб-приложение на Vercel
   - Интерфейс для всех взаимодействий
   - Голосовой и текстовый ввод
   - Отображение результатов

3. **Backend API** (FastAPI)
   - Обработка голосовых сообщений
   - Обработка текстовых сообщений
   - Управление ИИ-клонами
   - Система совместимости
   - Поиск совпадений

4. **ИИ-сервисы**
   - Анализ голосовых дневников
   - Создание и обновление клонов
   - Автоматическое общение клонов
   - Анализ совместимости

5. **База данных** (PostgreSQL)
   - Профили пользователей
   - Данные клонов
   - Дневники (текст + аудио)
   - Совместимости и совпадения
   - История общения клонов

6. **Очереди задач** (Celery + Redis)
   - Фоновая обработка дневников
   - Автоматическое общение клонов
   - Поиск совпадений
   - Генерация уведомлений

## Структура Telegram Mini App

### Главный экран

**Экран 1: Профиль клона**
- Статус клона (создан/в процессе)
- Процент точности клона
- Статистика: сколько дневников, сколько совместимостей найдено
- Кнопка "Записать дневник"
- Кнопка "Спросить у клона"

**Экран 2: Запись дневника**
- Два режима ввода:
  - **Голосовой**: кнопка записи, визуализация записи, таймер
  - **Текстовый**: текстовое поле для ввода
- Переключение между режимами
- Кнопка "Отправить дневник"
- История предыдущих дневников

**Экран 3: Совместимости**
- Список найденных совместимостей
- Карточки с процентом совместимости
- Что обсуждали клоны
- Почему подходят друг другу
- Кнопка "Показать профиль" (если пользователь согласен)

**Экран 4: Найденные совпадения**
- Вкладки: Вещи / Работа / Услуги
- Карточки совпадений с деталями
- Переговоры клонов (что они обсудили)
- Кнопка "Связаться"

**Экран 5: Аналитика клона**
- График эволюции точности
- Инсайты о личности
- Паттерны поведения
- Предсказания клона

**Экран 6: Настройки**
- Уведомления
- Видимость профиля
- Удаление клона
- Премиум подписка

## Поток взаимодействия пользователя

### Первый запуск

1. Пользователь открывает бота в Telegram
2. Бот приветствует и объясняет концепцию
3. Бот предлагает открыть Mini App (кнопка "Открыть приложение")
4. Mini App открывается в Telegram
5. Экран онбординга:
   - Объяснение как работает платформа
   - Запрос разрешений (микрофон для голосовых дневников)
6. Интерактивная анкета:
   - Система задает вопросы по очереди:
     * "Как тебя зовут?" → пользователь отвечает
     * "Сколько тебе лет?" → пользователь отвечает
     * "Из какого ты города?" → пользователь отвечает
     * Система анализирует имя и предполагает пол
     * "Вы мужчина или женщина?" → пользователь подтверждает/исправляет
   - Все ответы сохраняются в БД
   - Показывается прогресс заполнения анкеты
7. Первый дневник:
   - Предложение записать первый дневник
   - Выбор: голос или текст
   - Запись/ввод первого дневника
   - Отправка на обработку
7. Обработка:
   - Показывается экран "Создание вашего клона..."
   - ИИ анализирует дневник
   - Формируется базовый профиль клона
8. Готово:
   - "Ваш клон создан!"
   - Показывается первый инсайт о личности
   - Предложение записывать дневники ежедневно

### Ежедневное использование

**Сценарий 1: Запись дневника (голос)**

1. Пользователь открывает Mini App
2. На главном экране нажимает "Записать дневник"
3. Выбирает режим "Голос"
4. Нажимает кнопку записи
5. Говорит 1-2 минуты о своем дне
6. Останавливает запись
7. Видит превью: длительность, возможность прослушать
8. Нажимает "Отправить"
9. Аудио отправляется на бэкенд
10. Показывается прогресс обработки
11. После обработки показываются новые инсайты
12. Клон обновляется с новыми данными

**Сценарий 2: Запись дневника (текст)**

1. Пользователь открывает Mini App
2. Нажимает "Записать дневник"
3. Выбирает режим "Текст"
4. Вводит текст в поле (или диктует через голосовой ввод браузера)
5. Нажимает "Отправить"
6. Текст отправляется на бэкенд
7. Обработка и обновление клона

**Сценарий 3: Просмотр совместимостей**

1. Пользователь открывает Mini App
2. Переходит в раздел "Совместимости"
3. Видит список найденных совместимостей
4. Открывает карточку совместимости:
   - Процент совместимости
   - Уровни совместимости (ценности, эмоции, коммуникация)
   - Цитаты из общения клонов
   - Почему подходят друг другу
5. Может:
   - Показать свой профиль другому пользователю
   - Получить контакт (если взаимно)
   - Отклонить совместимость

**Сценарий 4: Найденные совпадения**

1. Пользователь получает уведомление от бота: "Ваш клон нашел совпадение!"
2. Открывает Mini App
3. Переходит в раздел "Совпадения"
4. Видит карточку:
   - Тип совпадения (вещь/работа/услуга)
   - Детали (что нужно/предлагается)
   - Локация
   - Переговоры клонов (что они обсудили)
   - Предложенные условия
5. Может:
   - Принять предложение
   - Отклонить
   - Связаться с пользователем

**Сценарий 5: Вопрос клону**

1. Пользователь на главном экране нажимает "Спросить у клона"
2. Вводит вопрос (текстом или голосом)
3. Клон анализирует вопрос на основе профиля пользователя
4. Показывается ответ клона
5. Можно задать уточняющие вопросы

## Анализ текста и голосовых сообщений

**Подробное описание процесса анализа и характеристик личности описано в файле `TEXT_ANALYSIS_AND_PERSONALITY.md`**

### Краткий обзор

**Процесс анализа:**
1. Голос → транскрипция через OpenAI Whisper API → текст
2. Текст → анализ через GPT-4 → структурированные данные о личности
3. Извлечение характеристик → сохранение в профиль клона и память

**Характеристики личности:**
- Ценности и приоритеты
- Эмоциональные паттерны
- Стиль общения
- Паттерны мышления
- Интересы и хобби
- Цели и мечты
- Страхи и проблемы
- Опыт и события
- Социальные характеристики
- Поведенческие паттерны

## Техническая реализация взаимодействия

### Голосовой ввод

**В Mini App:**
- Web Audio API для записи аудио
- MediaRecorder API для захвата звука
- Визуализация записи (волны, таймер)
- Ограничение времени записи (макс 5 минут)
- Возможность прослушать перед отправкой
- Конвертация в формат для отправки (WebM/OGG)

**На бэкенде:**
- Прием аудио файла
- Конвертация в нужный формат (если нужно)
- Отправка в OpenAI Whisper API для транскрипции
- Получение текста
- Анализ текста через OpenAI GPT API
- Сохранение аудио и текста в БД

### Текстовый ввод

**В Mini App:**
- Обычное текстовое поле
- Поддержка голосового ввода браузера (если доступно)
- Валидация минимальной длины
- Автосохранение черновиков

**На бэкенде:**
- Прием текста
- Валидация
- Анализ ИИ
- Сохранение в БД

## Схема работы ИИ-клона

### Создание клона

1. Пользователь отправляет первый дневник (голос/текст)
2. Транскрипция (если голос)
3. Анализ дневника:
   - Извлечение эмоций
   - Выявление ценностей
   - Определение интересов
   - Анализ стиля общения
   - Выявление паттернов мышления
4. Создание базового профиля клона
5. Сохранение в БД
6. Уведомление пользователя

### Обновление клона

1. Каждый новый дневник анализируется
2. Обновляется профиль клона:
   - Добавляются новые паттерны
   - Уточняются существующие
   - Обновляется "точность" клона
3. Пересчитывается совместимость с другими клонами

### Автоматическое общение клонов (БУДУЩАЯ ФУНКЦИЯ - не в MVP)

**Планируется для версии 2.0:**
1. Фоновая задача (Celery) каждые N минут:
   - Выбирает пары клонов для общения
   - Генерирует диалог между клонами
   - Анализирует совместимость
   - Сохраняет результаты
2. Если найдена высокая совместимость:
   - Создается запись о совместимости
   - Отправляется уведомление пользователям

**В MVP:** Совместимость будет определяться на основе сравнения профилей клонов без генерации диалогов

### Поиск совпадений потребностей

1. Анализ дневников на предмет потребностей:
   - "Мне нужен чайник" → потребность: чайник
   - "У меня лишний чайник" → предложение: чайник
2. Сопоставление потребностей и предложений через векторный поиск
3. **БУДУЩЕЕ (версия 2.0):** Клоны ведут переговоры:
   - Обсуждают условия
   - Договариваются о цене/обмене
   - Учитывают локацию
4. Если найдено совпадение:
   - Создается запись о совпадении
   - Уведомление пользователям
   - Пользователи сами договариваются (в MVP)

## База данных - структура

**Подробная схема БД и стратегия обучения клонов описана в файле `DATABASE_AND_AI_TRAINING.md`**

### Основные таблицы (краткий обзор)

**users** - Пользователи Telegram
- id, telegram_id, username, name, age, city, is_premium, created_at, updated_at

**clones** - ИИ-клоны пользователей
- id, user_id, personality_profile (JSONB), personality_embedding (VECTOR), accuracy_score, status, created_at, updated_at

**diaries** - Дневники пользователей
- id, user_id, clone_id, content_text, audio_file_path, analysis_result (JSONB), content_embedding (VECTOR), created_at, analyzed_at

**clone_memories** - Память клонов (факты, предпочтения, опыт)
- id, clone_id, memory_type, memory_content, memory_embedding (VECTOR), importance_score, created_at

**clone_conversations** - Общение между клонами
- id, clone1_id, clone2_id, messages (JSONB), compatibility_analysis (JSONB), created_at

**compatibilities** - Найденные совместимости
- id, clone1_id, clone2_id, overall_score, scores_by_level (JSONB), status, created_at

**needs** - Потребности и предложения
- id, user_id, need_type, direction, title, details (JSONB), need_embedding (VECTOR), status, created_at

**matches** - Совпадения потребностей
- id, user1_id, user2_id, match_type, clone_negotiations (JSONB), status, created_at

**clone_training_logs** - Логи обучения
- id, clone_id, training_type, training_data (JSONB), accuracy_before, accuracy_after, created_at

**notifications** - Уведомления
- id, user_id, type, title, content, read, created_at

## API Endpoints

### Дневники
- POST /api/diaries - создать дневник (текст или аудио)
- GET /api/diaries - список дневников пользователя
- GET /api/diaries/{id} - получить дневник

### Клон
- GET /api/clone - получить данные клона пользователя
- GET /api/clone/insights - получить инсайты о личности
- POST /api/clone/ask - задать вопрос клону

### Совместимости
- GET /api/compatibilities - список совместимостей
- GET /api/compatibilities/{id} - детали совместимости
- POST /api/compatibilities/{id}/accept - принять совместимость
- POST /api/compatibilities/{id}/reject - отклонить

### Совпадения
- GET /api/matches - список найденных совпадений
- GET /api/matches/{id} - детали совпадения
- POST /api/matches/{id}/accept - принять совпадение
- POST /api/matches/{id}/reject - отклонить

### Профиль
- GET /api/profile - получить профиль пользователя
- PUT /api/profile - обновить профиль
- GET /api/stats - статистика пользователя

### Онбординг (анкета)
- GET /api/onboarding/status - проверить статус анкеты
- POST /api/onboarding/answer - сохранить ответ на вопрос анкеты
- GET /api/onboarding/guess-gender - предположить пол по имени
- POST /api/onboarding/complete - завершить анкету

## Безопасность

### Валидация данных от Telegram

1. Mini App получает initData от Telegram
2. Отправляет initData на бэкенд при каждом запросе
3. Бэкенд проверяет подпись initData
4. Извлекает telegram_id пользователя
5. Проверяет авторизацию

### Защита API

- Все запросы требуют валидный initData
- Rate limiting на все endpoints
- Валидация всех входных данных
- Защита от SQL injection
- Защита от XSS в Mini App

## Развертывание

### Mini App (Vercel)
- React/Next.js приложение
- Автоматический деплой из GitHub
- Переменные окружения для API URL

### Backend (VPS/Cloud)
- FastAPI приложение в Docker
- PostgreSQL база данных
- Redis для очередей
- Celery workers для фоновых задач
- Nginx как reverse proxy

### Интеграция
- Mini App обращается к Backend API
- Backend обращается к Telegram Bot API
- Bot отправляет уведомления пользователям
- Bot открывает Mini App по команде

## Этапы разработки MVP

### Этап 1: Базовая инфраструктура (1-2 недели)
- Настройка Telegram бота
- Создание Mini App на Vercel (базовый интерфейс)
- Настройка Backend API (FastAPI)
- Настройка БД (PostgreSQL)
- Интеграция Telegram Web App API
- Валидация initData
- Реализация интерактивной анкеты при первом входе
  - Экран приветствия
  - Вопросы: имя, возраст, город, пол
  - Предположение пола по имени (через GPT или библиотеку)
  - Сохранение ответов в БД

### Этап 2: Голосовые и текстовые дневники (2-3 недели)
- Реализация записи голоса в Mini App
- Текстовый ввод в Mini App
- API для приема дневников
- Интеграция с OpenAI Whisper API (транскрипция голоса)
- Интеграция с OpenAI GPT API (анализ текста и создание клона)
- Настройка pgvector для векторного поиска
- Реализация системы извлечения фактов из дневников
- Сохранение дневников в БД с embeddings
- Создание базового клона с профилем личности
- Система памяти клонов (clone_memories)

### Этап 3: Профиль клона и инсайты (1-2 недели)
- Экран профиля клона в Mini App
- Отображение инсайтов о личности
- Статистика клона
- Обновление клона при новых дневниках
- Реализация RAG системы (поиск релевантных воспоминаний)
- Система ответов клона на вопросы пользователя
- Формирование системных промптов с контекстом

### Этап 4: Система совместимости (2-3 недели)
- Алгоритм сравнения профилей клонов (без генерации диалогов в MVP)
- Расчет совместимости по уровням (ценности, эмоции, коммуникация, образ жизни)
- Экран совместимостей в Mini App
- Уведомления о новых совместимостях
- **БУДУЩЕЕ:** Генерация диалогов между клонами (версия 2.0)

### Этап 5: Поиск совпадений (2-3 недели)
- Анализ дневников на потребности
- Сопоставление потребностей и предложений
- Переговоры клонов
- Экран совпадений в Mini App
- Уведомления о совпадениях

### Этап 6: Полировка и тестирование (1-2 недели)
- Исправление багов
- Улучшение UI/UX
- Оптимизация производительности
- Тестирование на разных устройствах
- Подготовка к запуску

## Технологии для MVP

### Frontend (Mini App)
- React или Next.js
- TypeScript
- Telegram Web App SDK (@twa-dev/sdk)
- Web Audio API для записи
- Axios для API запросов
- Tailwind CSS для стилей

### Backend
- Python 3.11+
- FastAPI
- PostgreSQL
- Redis
- Celery
- OpenAI API (GPT-4/GPT-3.5 для анализа текста и генерации)
- OpenAI Whisper API (транскрипция голоса)

### Инфраструктура
- Vercel (Mini App)
- VPS или Cloud (Backend)
- Docker для контейнеризации
- GitHub для версионирования

## Выбор ИИ-API: OpenAI и альтернативы

### Рекомендация: OpenAI API (для MVP)

**Почему OpenAI для старта:**

✅ **Стабильность и надежность**
- Проверенный сервис с высокой доступностью
- Отличная документация и поддержка
- Большое комьюнити и примеры кода

✅ **Полный функционал из коробки**
- **GPT-4/GPT-3.5** для анализа текста, генерации диалогов клонов
- **Whisper API** для транскрипции голоса (высокое качество, поддержка русского)
- Единый API ключ для всех сервисов

✅ **Простота интеграции**
- Официальные Python SDK
- Простая настройка и использование
- Хорошая обработка ошибок

✅ **Масштабируемость**
- Автоматическое масштабирование
- Не нужно управлять инфраструктурой
- Pay-as-you-go модель

**Минусы:**
- Стоимость может быть выше при больших объемах
- Зависимость от внешнего сервиса
- Данные обрабатываются на серверах OpenAI

### Альтернативы для рассмотрения

#### 1. DeepSeek API
**Плюсы:**
- Дешевле OpenAI (до 2-3 раз)
- Совместим с OpenAI API форматом (легко переключиться)
- Хорошее качество для анализа текста
- Поддержка русского языка

**Минусы:**
- Меньше готовых решений для голоса
- Меньше документации и примеров

**Когда использовать:** Если бюджет ограничен, но нужна совместимость с OpenAI

#### 2. Mistral AI
**Плюсы:**
- Открытые модели (можно fine-tuning)
- Хорошее качество
- Дешевле чем OpenAI
- Можно донастраивать под свои задачи

**Минусы:**
- Требует больше настройки
- Нет встроенного STT (нужен отдельный сервис)

**Когда использовать:** Если планируете fine-tuning моделей под специфику проекта

#### 3. Google Gemini (Vertex AI)
**Плюсы:**
- Мультимодальные возможности
- Очень длинный контекст (до 1M токенов)
- Хорошая интеграция с Google Cloud
- Качественная обработка текста

**Минусы:**
- Сложнее начать (нужна настройка GCP)
- Может быть дороже
- Меньше примеров для Telegram ботов

**Когда использовать:** Если уже используете Google Cloud, нужен очень длинный контекст

#### 4. Hugging Face (self-hosted или Inference API)
**Плюсы:**
- Полный контроль над данными
- Можно запустить локально
- Много моделей на выбор
- Бесплатно для self-hosted

**Минусы:**
- Требует мощную инфраструктуру (GPU)
- Нужно самому настраивать и поддерживать
- Больше времени на разработку

**Когда использовать:** Если критична приватность данных, есть ресурсы на инфраструктуру

#### 5. Soniox (для транскрипции)
**Плюсы:**
- Дешевле чем Whisper для STT
- Хорошее качество распознавания
- Поддержка множества языков

**Минусы:**
- Только для транскрипции (нужен отдельный LLM)
- Меньше известности

**Когда использовать:** Если нужно снизить стоимость транскрипции при больших объемах

### Гибридный подход (рекомендуется для масштабирования)

**Этап 1 (MVP):** OpenAI полностью
- Быстрый старт
- Стабильность
- Фокус на разработке функционала

**Этап 2 (Рост):** Гибрид
- **Транскрипция:** Soniox или self-hosted Whisper (дешевле при масштабе)
- **Анализ текста:** OpenAI GPT-4 для сложных задач, GPT-3.5 для простых
- **Генерация диалогов:** OpenAI или DeepSeek (зависит от бюджета)

**Этап 3 (Масштаб):** Оптимизация
- Fine-tuned модели на своих данных (Mistral/Llama)
- Self-hosted для критичных частей
- OpenAI для сложных задач

### Сравнение стоимости (примерно)

Для задачи: 1000 пользователей, 1 дневник в день, ~500 слов каждый

**OpenAI:**
- Whisper транскрипция: ~$0.006 за минуту аудио
- GPT-4 анализ: ~$0.03 за 1K токенов
- Примерно: $50-100/мес для MVP

**DeepSeek:**
- Нет встроенного STT (нужен отдельный)
- GPT-аналог: ~$0.01 за 1K токенов
- Примерно: $30-50/мес + стоимость STT

**Self-hosted (Llama 3.1):**
- Инфраструктура: $200-500/мес (GPU сервер)
- Но неограниченное использование
- Выгодно при >5000 пользователей

### Итоговая рекомендация

**Для MVP:** Используйте **OpenAI API**
- GPT-4 для анализа личности и создания клонов
- GPT-3.5 для простых задач (дешевле)
- Whisper для транскрипции голоса
- Простота и скорость разработки важнее экономии на старте

**Для масштабирования:** Планируйте переход на гибрид
- Архитектура должна позволять легко менять провайдеров API
- Используйте абстракции (слой для работы с ИИ)
- Мониторьте стоимость и качество
- Переходите на альтернативы когда это экономически оправдано

## Метрики для отслеживания

- Количество активных пользователей
- Количество дневников в день
- Средняя длина дневника
- Процент использования голоса vs текста
- Количество созданных клонов
- Количество найденных совместимостей
- Количество найденных совпадений
- Конверсия совместимостей в контакты
- Конверсия совпадений в сделки
- Точность клонов (accuracy_score)
